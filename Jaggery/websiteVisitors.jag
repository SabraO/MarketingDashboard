<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<%
    var config = require("/config.json");

    var db = new Database("jdbc:mysql://localhost:3306/WSO2MarketingDashboardData", "root", "root");

    require("js/modules/date.js");
    var dateJs = require("/js/util/dateFunction.js");
    var initialization = require("/js/config/initialization.js");

    var websiteVisitors = config.webSiteVisitors;
    var firstDate, firstDateString, lastDate, lastDateString, previousWeekFirstDate, previousWeekFirstDateString,
                                        previousWeekLastDate, previousWeekLastDateString, year, previousYear, quarter;

    year = dateJs.getYear();

    lastDate = dateJs.getLastDate();
    lastDateString = dateJs.yyyymmdd(lastDate);

    var dataManipulation = require("/js/util/dataManipulation.js");

    var prevQuarter;

    if (dateJs.weekRangeContainsEOQ(firstDate, lastDate) == 1) {
        if (quarter != 1) {
            prevQuarter = quarter - 1;
            dataManipulation.setQuarterlyData("WebsiteVisitors", quarter, prevQuarter, year, year, lastDateString);
        }
        else {
            prevQuarter = 4;

            dataManipulation.setYearlyData("WebsiteVisitors", year, previousYear, prevQuarter, lastDateString);
            dataManipulation.setQuarterlyData("WebsiteVisitors", quarter, prevQuarter, year, previousYear,
                                                                                                        lastDateString);
        }
    }

    //Query dashboard query parameters to get values
    var dashboardParameters = db.query("SELECT * FROM `DashboardQueryParameters` WHERE `year` = " + year +
                                                                        " AND `lastDate` = \"" + lastDateString + "\"");
    previousYear = dashboardParameters[0].previousYear;
    quarter = dashboardParameters[0].quarter;
    firstDateString = dashboardParameters[0].firstDate;
    previousWeekFirstDateString = dashboardParameters[0].prevWeekFirstDate;
    previousWeekLastDateString = dashboardParameters[0].prevWeekLastDate;

    var dashboardData = dataManipulation.getDashboardData("WebsiteVisitors", websiteVisitors, year, previousYear,
                    quarter, firstDateString, lastDateString, previousWeekFirstDateString, previousWeekLastDateString);

    //To show in table, get the dashboard data for previous quarters
    var websiteVisitor_PrevQuarterData = dataManipulation.getPrevQuarterData("WebsiteVisitors", quarter);

    //To display in graphs
    //WoW Performance - This week and Last 4 weeks (Total 5 weeks)
    var dateRanges = [];

    var weeksLastDate = dateJs.getLastDate();

    //Date Range Calculation
    for(var i =0; i < 5;i++){
         var dateRange = {
         "firstDate" : "",
         "lastDate" : ""
         };

         var date_first = new Date();
         date_first.setDate(weeksLastDate.getDate() - 6 - (7*i));
         var dateFirstString = yyyymmdd(date_first);
         dateRange.firstDate = dateFirstString;

         var date_last = new Date();
         date_last.setDate(weeksLastDate.getDate() - (7*i));
         var dateLastString = yyyymmdd(date_last);
         dateRange.lastDate = dateLastString;

         dateRanges.push(dateRange);
    }

    var websiteVisitors_weeklyData = dataManipulation.getWeeklyData("WebsiteVisitors");

    //Yearly Comparison
    var websiteVisitors_yearlyData = dataManipulation.getYearlyData("WebsiteVisitors");

    //Quarterly Comparison
    var websiteVisitors_QDataThisYear = dataManipulation.getQuarterlyData_ThisYear(websiteVisitor_PrevQuarterData,
                                                                                                        dashboardData);
    var websiteVisitors_QDataPrevYear = dataManipulation.getQuarterlyData_PrevYear("WebsiteVisitors");

    //Forecast vs Cumulative
    var forecast_Quarter = dashboardData.forecast_Quarter;
    var cumulative_Quarter = dashboardData.cumulative_Quarter;

    var yearD = "" + year;
    var quarterD = "" + quarter;
    var previousYearD = "" + previousYear;
%>

<head>
     <script src="js/modules/jquery-2.1.1.min.js" type="text/javascript"></script>
     <script src="js/modules/highcharts.js" type="text/javascript"></script>
     <script src="js/modules/exporting.js" type="text/javascript"></script>
     <script src="js/config/graph.js" type="text/javascript"></script>
     <script src="js/config/table.js" type="text/javascript"></script>

     <script type="text/javascript">

          $(document).ready(function() {

               var dashboardData = JSON.parse('<%=dashboardData%>');
               var year = '<%=yearD%>';
               var quarter = '<%=quarterD%>';
               var previousYear = '<%=previousYearD%>';
               var firstDateString = '<%=firstDateString%>';
               var lastDateString = '<%=lastDateString%>';
               var prevWeekFirstDateString = '<%=previousWeekFirstDateString%>';
               var prevWeekLastDateString = '<%=previousWeekLastDateString%>';

               var previousQuartersData = JSON.parse('<%=websiteVisitor_PrevQuarterData%>');

               var tableContent = populateDashboard("Website Visitors",dashboardData,year,quarter,previousYear,
                firstDateString,lastDateString,prevWeekFirstDateString,prevWeekLastDateString,previousQuartersData);

               $("#table").html(tableContent);

               //Draw Graphs

               //Website Visitors
               //WoW Performance
               var weeklyData = JSON.parse('<%=websiteVisitors_weeklyData%>');
               var dateRanges = JSON.parse('<%=dateRanges%>');
               var forecast_Quarter = JSON.parse('<%=forecast_Quarter%>');

                //Quarterly Comparison
                var qDataThisYear = JSON.parse('<%=websiteVisitors_QDataThisYear%>');
                var qDataPrevYear = JSON.parse('<%=websiteVisitors_QDataPrevYear%>');

                //Yearly Comparison
                var yearlyData = JSON.parse('<%=websiteVisitors_yearlyData%>');

                //Forecast vs Cumulative
                var forecastQ = JSON.parse('<%=forecast_Quarter%>');
                var cumulativeQ = JSON.parse('<%=cumulative_Quarter%>');

                var forecastTotal = parseInt(forecastQ.total);
                var forecastNA = parseInt(forecastQ.na);
                var forecastEU = parseInt(forecastQ.eu);
                var forecastREST = parseInt(forecastQ.rest);

                drawGraphs(quarter,"Website Visitors",year,previousYear,weeklyData,dateRanges,forecast_Quarter,
                                                        qDataThisYear,qDataPrevYear,yearlyData,forecastQ,cumulativeQ);

                $("#wv").click(function() {
                     location = "websiteVisitors.jag";
                });
                $("#rl").click(function() {
                     location = "rawLeads.jag";
                });
                $("#sql").click(function() {
                     location = "salesQualifiedLeads.jag";
                });
          });

     </script>
</head>

<body>

     <div id="wv">Website Visitors</div>
     <div id="rl">Raw Leads</div>
     <div id="sql">Sales Qualified Leads</div>

     <div id="dashboard">
          <table id="table">

          </table>
     </div>

     <br>
     <div id="WoWPerformanceComparison" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

     <br>
     <div id="quarterlyComparison" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

     <br>
     <div id="yearlyComparison" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

     <br>
     <div id="forecastVsCumulativeComparison_Total" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

     <br>
     <div id="forecastVsCumulativeComparison_NA" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

     <br>
     <div id="forecastVsCumulativeComparison_EU" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

     <br>
     <div id="forecastVsCumulativeComparison_REST" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
</body>

</html>


